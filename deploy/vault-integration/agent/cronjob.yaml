apiVersion: v1
kind: Namespace
metadata:
  name: alcide-advisor
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: advisorjob
  namespace: alcide-advisor
spec:
  schedule: "*/1 * * * *"

  # Keep the last run
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  # Concurrency is not required
  concurrencyPolicy: Forbid

  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: advisor
            run: alcide-advisor
            version: dev
        spec:
          initContainers:
            - name: vault-agent-auth
              args:
                - agent
                - -config=/etc/vault/vault-agent-config.hcl
              env:
                - name: VAULT_ADDR
                  value: http://vault.demo:8200
                - name: VAULT_AGENT_ADDR
                  value: http://localhost:8100
              image: vault
              imagePullPolicy: IfNotPresent
              resources: {}
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
              volumeMounts:
                - mountPath: /etc/vault
                  name: config
                - mountPath: /home/vault
                  name: vault-token
            - name: alcide-advisor
              image: alcide/advisor:stable
              imagePullPolicy: Always
              args:
                  - --eula-sign
                  - validate
                  - cluster
                  - --inCluster
                  - --output
                  - json
                  - --outfile
                  - /home/vault/advisor.json
                  - --debug
              volumeMounts:
                - mountPath: /home/vault
                  name: vault-token
              securityContext:
                  allowPrivilegeEscalation: false
                  capabilities:
                    drop:
                    - ALL
                  runAsNonRoot: true
                  runAsUser: 10001
          containers:
            - name: alcide-cli
              image: python:3.8.1-alpine
              imagePullPolicy: IfNotPresent
              command: [sh, -c, "pip install awscli && aws s3 cp /home/vault/advisor.json s3://${S3_DESTINATION} --acl private"]
              resources: {}
              env:
                - name: AWS_SHARED_CREDENTIALS_FILE
                  value: /home/vault/secrets/aws/credentials
                - name: AWS_REGION
                  value: us-east-2
                - name: S3_DESTINATION
                  value: <S3 BucketName>/advisor.json
              volumeMounts:
                - mountPath: /home/vault
                  name: vault-token
          serviceAccountName: alcide-advisor
          volumes:
            - emptyDir:
                medium: Memory
              name: vault-token
            - configMap:
                defaultMode: 420
                items:
                  - key: vault-agent-config.hcl
                    path: vault-agent-config.hcl
                name: vault-agent-config
              name: config
          restartPolicy: OnFailure
